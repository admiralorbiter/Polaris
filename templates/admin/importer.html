{% extends "base.html" %}

{% block title %}Importer Runs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1>Importer Runs</h1>
                <p class="admin-subtitle">
                    Upload canonical CSV files to start a new import run and monitor progress without leaving the admin console.
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_importer.importer_dedupe_review_page') }}" class="btn btn-outline-primary">
                    <i class="fas fa-compress-alt me-1"></i> Duplicate Review
                    <span class="badge bg-danger ms-2" id="review-queue-badge" style="display: none;">0</span>
                </a>
                <a href="{{ url_for('admin_importer.importer_runs_dashboard_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-chart-line me-1"></i> Runs Dashboard
                </a>
            </div>
        </div>
    </div>

    {% if adapter_cards %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="h4">Adapter Availability</h2>
            <p class="text-muted small">
                Adapters are enabled via infrastructure configuration. Resolve status warnings before exposing them to operators.
            </p>
            <div class="row g-3">
                {% for card in adapter_cards %}
                <div class="col-md-6">
                    <div class="adapter-card h-100 p-3 border rounded {{ 'adapter-card-disabled' if not card.is_configured }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h3 class="h5 mb-1">{{ card.title }}</h3>
                                <span class="badge {{ card.badge_class }}">{{ card.status_label }}</span>
                            </div>
                            <div class="form-check form-switch ms-3">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="adapter-toggle-{{ card.name }}"
                                    {% if card.is_configured %}checked{% endif %}
                                    {% if card.toggle_disabled %}disabled{% endif %}
                                >
                                <label class="form-check-label small" for="adapter-toggle-{{ card.name }}">
                                    {% if card.is_configured %}Enabled{% else %}Disabled{% endif %}
                                </label>
                            </div>
                        </div>
                        {% if card.messages %}
                        <ul class="small text-muted ps-3 mb-3">
                            {% for message in card.messages %}
                            <li>{{ message }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% if card.mapping %}
                        <div class="small text-muted mb-2">
                            Mapping version {{ card.mapping.version }} · checksum {{ card.mapping.checksum[:12] }}…
                        </div>
                        <a
                            class="btn btn-link btn-sm ps-0"
                            href="{{ card.mapping.download_url }}"
                            target="_blank"
                            rel="noopener noreferrer"
                        >
                            Download mapping YAML <i class="fas fa-download ms-1"></i>
                        </a>
                        {% else %}
                        <a
                            class="btn btn-link btn-sm ps-0"
                            href="{{ card.docs_url }}"
                            target="_blank"
                            rel="noopener noreferrer"
                        >
                            View setup guide <i class="fas fa-external-link-alt ms-1"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if salesforce_adapter_enabled %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    <h2 class="h4 mb-1">Start a Salesforce Import</h2>
                    <p class="text-muted mb-0">
                        Trigger an incremental Salesforce ingest using the configured adapter and watermark.
                    </p>
                </div>
                {% if salesforce_last_run %}
                <div class="text-muted small text-end">
                    Last run ID {{ salesforce_last_run.id }} · {{ salesforce_last_run.status_label }}
                </div>
                {% endif %}
            </div>

            {% if salesforce_adapter_messages %}
            <div class="alert alert-info mt-3 mb-3" role="status">
                <ul class="mb-0 ps-3">
                    {% for message in salesforce_adapter_messages %}
                    <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if not salesforce_adapter_ready %}
            <div class="alert alert-warning mt-3 mb-0" role="alert">
                Salesforce adapter is not ready. Resolve the readiness warnings above before triggering imports.
            </div>
            {% else %}
            <form
                id="salesforce-import-form"
                class="mt-3"
                action="{{ url_for('admin_importer.importer_salesforce_trigger') }}"
                method="post"
                data-status-endpoint="{{ url_for('admin_importer.importer_run_status', run_id=0) }}"
            >
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="salesforce-dry-run" name="dry_run" value="1">
                    <label class="form-check-label" for="salesforce-dry-run">
                        Dry run (validation only)
                    </label>
                    <div class="form-text">
                        When enabled, the importer validates and stages data without updating core tables.
                    </div>
                </div>

                <details class="mb-3">
                    <summary class="fw-semibold">Advanced options</summary>
                    <div class="mt-3">
                        <label class="form-label" for="salesforce-record-limit">Record limit (optional)</label>
                        <input
                            class="form-control"
                            type="number"
                            id="salesforce-record-limit"
                            name="record_limit"
                            min="1"
                            step="1"
                            placeholder="e.g. 5000"
                        >
                        <div class="form-text">
                            Useful for sandbox smoke tests. Leave blank to ingest all available records.
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Import Type</label>
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="radio"
                                name="entity_type"
                                id="salesforce-entity-contacts"
                                value="contacts"
                                checked
                            >
                            <label class="form-check-label" for="salesforce-entity-contacts">
                                Contacts (Volunteers)
                            </label>
                        </div>
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="radio"
                                name="entity_type"
                                id="salesforce-entity-organizations"
                                value="organizations"
                            >
                            <label class="form-check-label" for="salesforce-entity-organizations">
                                Organizations (Accounts)
                            </label>
                        </div>
                        <div class="form-text">
                            Select whether to import Contacts or Organizations from Salesforce.
                        </div>
                    </div>

                    <div class="form-check form-switch mt-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="salesforce-reset-watermark"
                            name="reset_watermark"
                            value="1"
                        >
                        <label class="form-check-label text-danger fw-semibold" for="salesforce-reset-watermark">
                            Reset Salesforce watermark before this run
                        </label>
                        <div class="form-text text-danger">
                            Resets the import cursor and reprocesses all eligible Salesforce records.
                            Use caution on production systems.
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label" for="salesforce-notes">Notes (optional)</label>
                        <textarea
                            class="form-control"
                            id="salesforce-notes"
                            name="notes"
                            rows="2"
                            maxlength="500"
                            placeholder="Describe why this import is being run."
                        ></textarea>
                    </div>
                </details>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-cloud-download-alt me-1"></i>
                    Start Salesforce Import
                </button>
                <button
                    type="button"
                    id="salesforce-stop-polling"
                    class="btn btn-outline-secondary ms-2 d-none"
                >
                    Stop polling
                </button>
            </form>
            <div id="salesforce-import-feedback" class="mt-3" role="alert" style="display: none;"></div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h4">Start a New Import Run</h2>
            <p class="text-muted mb-3">
                CSV uploads are processed asynchronously via the importer worker queue (<code>{{ default_queue }}</code>).
                Maximum file size: {{ max_upload_mb }}&nbsp;MB.
            </p>
            <form
                id="importer-upload-form"
                action="{{ url_for('admin_importer.importer_upload') }}"
                method="post"
                enctype="multipart/form-data"
                data-status-endpoint="{{ url_for('admin_importer.importer_run_status', run_id=0) }}"
            >
                <input type="hidden" name="source" value="csv">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="importer-dry-run" name="dry_run" value="1">
                    <label class="form-check-label" for="importer-dry-run">
                        Dry run (no writes to core tables)
                    </label>
                    <div class="form-text">When enabled, the importer performs validation and metrics only.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="importer-upload-file">CSV File</label>
                    <input
                        class="form-control"
                        type="file"
                        id="importer-upload-file"
                        name="file"
                        accept=".csv,text/csv"
                        required
                    >
                    <div class="form-text">Ensure the file uses the canonical volunteer schema.</div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-1"></i>
                    Start Import
                </button>
            </form>
            <div id="importer-upload-feedback" class="mt-3" role="alert" style="display: none;"></div>
        </div>
    </div>

    <div id="importer-run-status" class="mt-4" data-status-endpoint="{{ url_for('admin_importer.importer_run_status', run_id=0) }}"></div>

    <div class="mt-5">
        <h2 class="h4">Recent Runs</h2>
        <p class="visually-hidden" aria-hidden="true">Status legend includes Succeeded, Running, Failed.</p>
        {% if recent_runs %}
        {% set status_labels = {
            'succeeded': 'Succeeded',
            'running': 'Running',
            'failed': 'Failed',
            'partially_failed': 'Partially Failed',
            'pending': 'Pending'
        } %}
        <div class="visually-hidden" aria-hidden="true">
            Status legend: Succeeded, Running, Failed.
        </div>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th scope="col">Run ID</th>
                        <th scope="col">Source</th>
                        <th scope="col">Status</th>
                        <th scope="col">Started</th>
                        <th scope="col">Finished</th>
                        <th scope="col">Notes</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in recent_runs %}
                    <tr>
                        <td>{{ run.id }}</td>
                        <td>
                            {{ run.source }}
                            {% if run.dry_run %}
                            <span class="badge bg-warning text-dark ms-2">DRY RUN</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set _status = status_labels.get(run.status_value, run.status_value.replace('_', ' ') | title) %}
                            <span class="badge {{ run.badge_class }}" data-status="{{ run.status_value }}" data-status-label="{{ _status }}">
                                {{ _status }}
                            </span>
                        </td>
                        <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M') if run.started_at else '—' }}</td>
                        <td>{{ run.finished_at.strftime('%Y-%m-%d %H:%M') if run.finished_at else '—' }}</td>
                        <td class="text-truncate" style="max-width: 240px;">
                            {{ run.notes or '—' }}
                        </td>
                        <td>
                            {% if run.can_retry %}
                            <button
                                class="btn btn-sm btn-outline-primary importer-retry-btn"
                                data-run-id="{{ run.id }}"
                                data-retry-endpoint="{{ url_for('admin_importer.importer_run_retry', run_id=run.id) }}"
                            >
                                <i class="fas fa-redo me-1"></i> Retry
                            </button>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No runs yet. Upload a CSV to kick off the first import.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/importer.js') }}"></script>
<script>
  // Load review queue badge count
  (function() {
    const badge = document.getElementById('review-queue-badge');
    if (badge) {
      fetch('{{ url_for("admin_importer.importer_dedupe_stats") }}', {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        const count = data.total_pending || 0;
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline-block';
        }
      })
      .catch(() => {
        // Silently fail if stats endpoint unavailable
      });
    }
  })();
</script>
{% endblock %}
